#!/bin/bash
set -x -e
export ELEMENTAL_REGISTER_UPGRADE_CORRELATION_ID="${ELEMENTAL_REGISTER_UPGRADE_CORRELATION_ID}"
export ELEMENTAL_REGISTER_UPGRADE_SNAPSHOT_LABELS="${ELEMENTAL_REGISTER_UPGRADE_SNAPSHOT_LABELS}"
export ELEMENTAL_REGISTER_UPGRADE_RECOVERY="${ELEMENTAL_REGISTER_UPGRADE_RECOVERY:-$UPGRADE_RECOVERY}"
export ELEMENTAL_REGISTER_UPGRADE_RECOVERY_ONLY="${ELEMENTAL_REGISTER_UPGRADE_RECOVERY_ONLY:-$UPGRADE_RECOVERY_ONLY}"

# Cope with elemental-operator < 1.8.x versions that will not pass any correlation ID
if [ -z "${ELEMENTAL_REGISTER_UPGRADE_CORRELATION_ID}" ]; then
    ELEMENTAL_REGISTER_UPGRADE_CORRELATION_ID="$(sha256sum /etc/os-release | cut -d " " -f 1)"
fi

echo "Applying upgrade: ${ELEMENTAL_REGISTER_UPGRADE_CORRELATION_ID}"

elemental-register upgrade --debug
